# docker-compose.staging.yml
# Override file for staging deployment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.staging.yml up

version: '3.8'

services:
  postgres:
    environment:
      - POSTGRES_DB=flashcards_staging
      - POSTGRES_USER=flashcards_staging
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-flashcards_staging_password}
    # Remove port exposure for staging security
    ports: []

  app:
    build:
      target: production
    environment:
      - DATABASE_URL=postgresql://flashcards_staging:${POSTGRES_PASSWORD:-flashcards_staging_password}@postgres:5432/flashcards_staging
      - ENVIRONMENT=staging
      - DEBUG=false
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_AI_PROVIDER=${DEFAULT_AI_PROVIDER:-anthropic}
    # Remove development volume mounts but keep logs
    volumes:
      - ./logs:/app/logs
    # Staging command with fewer workers than production
    command: ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "2"]
    restart: unless-stopped

  # Keep pgAdmin available in staging for debugging
  pgadmin:
    environment:
      - PGADMIN_DEFAULT_EMAIL=staging@flashcards.local
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-staging_admin_password}