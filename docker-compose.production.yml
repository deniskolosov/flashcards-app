# docker-compose.production.yml
# Override file for production deployment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.production.yml up

version: '3.8'

services:
  postgres:
    # Production PostgreSQL configuration
    environment:
      - POSTGRES_DB=flashcards_prod
      - POSTGRES_USER=flashcards_prod
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # Should be set in environment
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
    volumes:
      # Remove the init script for production (should be managed by migrations)
      - postgres_data:/var/lib/postgresql/data
    # Remove port exposure for security (only accessible within Docker network)
    ports: []
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.7
      -c wal_buffers=16MB
      -c default_statistics_target=100

  app:
    build:
      target: production
    environment:
      - DATABASE_URL=postgresql://flashcards_prod:${POSTGRES_PASSWORD}@postgres:5432/flashcards_prod
      - ENVIRONMENT=production
      - DEBUG=false
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_AI_PROVIDER=${DEFAULT_AI_PROVIDER:-anthropic}
    # Remove development volume mounts
    volumes:
      - ./logs:/app/logs
    # Production command (no reload)
    command: ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Remove pgAdmin in production
  pgadmin:
    profiles:
      - debug